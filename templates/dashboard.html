{% extends "base.html" %}

{% block title %}Dashboard - CE Tracker{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Your CE Records</h1>
        <div class="header-actions">
            <button type="button" class="btn btn-primary" onclick="openAddCEModal()">+ Add New CE</button>
            <button type="button" class="btn btn-secondary" onclick="openImportModal()">ðŸ“¤ Import CSV</button>
            <a href="{{ url_for('ce_records.export_ce', category=filter_category) }}" class="btn btn-secondary">ðŸ“¥ Export CSV</a>
            <a href="{{ url_for('ce_records.export_pdf', category=filter_category) }}" class="btn btn-secondary">ðŸ“„ Export PDF</a>
        </div>
    </div>

    {% if user_designations %}
    <div class="designations-section">
        <h2>Your Designations</h2>
        <div class="designation-badges">
            {% for user_designation in user_designations %}
            <span class="designation-badge-small">
                {{ user_designation.designation }}
                {% if user_designation.designation == 'CPA' and user_designation.state %}
                ({{ user_designation.state }})
                {% endif %}
            </span>
            {% endfor %}
            <a href="{{ url_for('designations.manage_designations') }}" class="btn btn-secondary btn-sm">Manage</a>
        </div>
    </div>
    
    {% if designation_requirements %}
    <div class="designation-requirements-section">
        <h2>CE Requirements Progress</h2>
        <div class="requirements-grid">
            {% for req in designation_requirements %}
            <div class="requirement-card {% if req.is_complete %}complete{% endif %}">
                <div class="requirement-header">
                    <h3>
                        {{ req.designation }}
                        {% if req.state %}({{ req.state }}){% endif %}
                    </h3>
                    {% if req.is_complete %}
                    <span class="status-badge complete">âœ“ Complete</span>
                    {% else %}
                    <span class="status-badge incomplete">In Progress</span>
                    {% endif %}
                </div>
                
                <div class="requirement-period">
                    <small>Reporting Period: {{ req.period_start.strftime('%b %d, %Y') }} - {{ req.period_end.strftime('%b %d, %Y') }}</small>
                </div>
                
                <div class="requirement-progress-main">
                    <div class="progress-header">
                        <span class="progress-label">Total Hours</span>
                        <span class="progress-numbers">{{ "%.1f"|format(req.total_earned) }} / {{ "%.1f"|format(req.total_required) }}</span>
                    </div>
                    <div class="progress-bar-large">
                        <div class="progress-fill-large" style="width: {{ req.total_percentage }}%"></div>
                    </div>
                    {% if req.total_remaining > 0 %}
                    <p class="remaining-text">{{ "%.1f"|format(req.total_remaining) }} hours remaining</p>
                    {% else %}
                    <p class="complete-text">âœ“ Requirement met!</p>
                    {% endif %}
                </div>
                
                {% if req.ethics_required %}
                <div class="requirement-progress-sub">
                    <div class="progress-header">
                        <span class="progress-label">Ethics Hours</span>
                        <span class="progress-numbers">{{ "%.1f"|format(req.ethics_earned) }} / {{ "%.1f"|format(req.ethics_required) }}</span>
                    </div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" style="width: {{ req.ethics_percentage }}%"></div>
                    </div>
                    {% if req.ethics_remaining > 0 %}
                    <p class="remaining-text-small">{{ "%.1f"|format(req.ethics_remaining) }} hours remaining</p>
                    {% else %}
                    <p class="complete-text-small">âœ“ Ethics requirement met!</p>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if req.yearly_minimum %}
                <div class="requirement-progress-sub">
                    <div class="progress-header">
                        <span class="progress-label">Current Year Minimum</span>
                        <span class="progress-numbers">{{ "%.1f"|format(req.current_year_hours) }} / {{ "%.1f"|format(req.yearly_minimum) }}</span>
                    </div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" style="width: {{ req.yearly_percentage }}%"></div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="designations-section">
        <p>No designations yet. <a href="{{ url_for('designations.manage_designations') }}">Add your designations</a> to track CE requirements!</p>
    </div>
    {% endif %}

    {% if napfa_requirements %}
    <div class="napfa-section">
        <div class="napfa-header">
            <h2>NAPFA CE Requirements</h2>
            <form method="POST" action="{{ url_for('ce_records.toggle_napfa_tracking') }}" style="display: inline;">
                <button type="submit" class="btn btn-secondary btn-sm">
                    {{ 'Hide' if show_napfa else 'Show' }} NAPFA Tracking
                </button>
            </form>
        </div>
        {% if show_napfa %}
        <div class="napfa-status">
            <div class="napfa-cycle-info">
                <p><strong>Current Cycle:</strong> {{ napfa_requirements.cycle_start.strftime('%B %d, %Y') }} - {{ napfa_requirements.cycle_end.strftime('%B %d, %Y') }}</p>
            </div>
            
            <div class="napfa-requirements-grid">
                <div class="napfa-requirement-item {% if napfa_requirements.is_complete %}complete{% endif %}">
                    <div class="requirement-header">
                        <span class="requirement-label">Total CE Hours</span>
                        {% if napfa_requirements.is_complete %}
                        <span class="requirement-status complete">âœ“ Complete</span>
                        {% else %}
                        <span class="requirement-status incomplete">Incomplete</span>
                        {% endif %}
                    </div>
                    <div class="requirement-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ napfa_requirements.total_percentage }}%"></div>
                        </div>
                        <span class="progress-text">{{ "%.1f"|format(napfa_requirements.total_earned) }} / {{ napfa_requirements.total_required }} hours</span>
                    </div>
                    {% if napfa_requirements.total_remaining > 0 %}
                    <p class="requirement-remaining">{{ "%.1f"|format(napfa_requirements.total_remaining) }} hours remaining</p>
                    {% endif %}
                </div>

                <div class="napfa-requirement-item {% if napfa_requirements.napfa_approved_earned >= napfa_requirements.napfa_approved_required %}complete{% endif %}">
                    <div class="requirement-header">
                        <span class="requirement-label">NAPFA-Approved Sources</span>
                        {% if napfa_requirements.napfa_approved_earned >= napfa_requirements.napfa_approved_required %}
                        <span class="requirement-status complete">âœ“ Complete</span>
                        {% else %}
                        <span class="requirement-status incomplete">Incomplete</span>
                        {% endif %}
                    </div>
                    <div class="requirement-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ napfa_requirements.napfa_approved_percentage }}%"></div>
                        </div>
                        <span class="progress-text">{{ "%.1f"|format(napfa_requirements.napfa_approved_earned) }} / {{ napfa_requirements.napfa_approved_required }} hours</span>
                    </div>
                    {% if napfa_requirements.napfa_approved_remaining > 0 %}
                    <p class="requirement-remaining">{{ "%.1f"|format(napfa_requirements.napfa_approved_remaining) }} hours remaining</p>
                    {% endif %}
                </div>

                <div class="napfa-requirement-item {% if napfa_requirements.ethics_completed %}complete{% endif %}">
                    <div class="requirement-header">
                        <span class="requirement-label">2-CE Ethics Course</span>
                        {% if napfa_requirements.ethics_completed %}
                        <span class="requirement-status complete">âœ“ Complete</span>
                        {% else %}
                        <span class="requirement-status incomplete">Required</span>
                        {% endif %}
                    </div>
                    {% if not napfa_requirements.ethics_completed %}
                    <p class="requirement-remaining">You must complete a 2-CE Ethics course</p>
                    {% endif %}
                </div>
            </div>

            {% if napfa_requirements.is_complete %}
            <div class="napfa-complete-message">
                <p>âœ“ Congratulations! You have met all NAPFA CE requirements for the current cycle.</p>
            </div>
            {% else %}
            <div class="napfa-info">
                <p><small>Based on <a href="https://www.napfa.org/member-resources/ce-guidelines" target="_blank">NAPFA CE Guidelines</a>. Mark CEs as "NAPFA-Approved" when adding them to count toward the approved sources requirement.</small></p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="stats-card">
        <div class="stat-item">
            <span class="stat-label">Total CE Hours{% if filter_category %} ({{ filter_category }}){% endif %}</span>
            <span class="stat-value">{{ "%.1f"|format(total_hours) }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Total Records{% if filter_category %} ({{ filter_category }}){% endif %}</span>
            <span class="stat-value">{{ ce_records|length }}</span>
        </div>
    </div>

    {% if ce_records %}
    <div class="table-container">
        <div class="filter-section">
            <form method="GET" action="{{ url_for('ce_records.dashboard') }}" class="filter-form">
                <div class="filter-group">
                    <label for="category">Filter by Category:</label>
                    <select id="category" name="category" onchange="this.form.submit()">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if filter_category == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% if filter_category %}
                <a href="{{ url_for('ce_records.dashboard') }}" class="btn btn-secondary btn-sm">Clear Filter</a>
                {% endif %}
            </form>
        </div>
        <table class="ce-table">
            <thead>
                <tr>
                    <th>Date Completed</th>
                    <th>Title</th>
                    <th>Provider</th>
                    <th>Category</th>
                    <th>Hours</th>
                    {% if napfa_requirements %}
                    <th>NAPFA</th>
                    {% endif %}
                    <th>Certificate</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for record in ce_records %}
                <tr>
                    <td>{{ record.date_completed.strftime('%Y-%m-%d') }}</td>
                    <td><strong>{{ record.title }}</strong></td>
                    <td>{{ record.provider or '-' }}</td>
                    <td>{{ record.category or '-' }}</td>
                    <td class="hours-cell">{{ "%.1f"|format(record.hours) }}</td>
                    {% if napfa_requirements %}
                    <td>
                        {% if record.is_napfa_approved %}
                        <span class="napfa-badge approved" title="NAPFA-Approved Source">âœ“ Approved</span>
                        {% endif %}
                        {% if record.is_ethics_course %}
                        <span class="napfa-badge ethics" title="2-CE Ethics Course">âš– Ethics</span>
                        {% endif %}
                        {% if not record.is_napfa_approved and not record.is_ethics_course %}
                        <span class="napfa-badge none">-</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td>
                        {% if record.certificate_filename %}
                        <a href="{{ url_for('ce_records.download_certificate', ce_id=record.id) }}" class="certificate-link" target="_blank" title="Download Certificate">
                            ðŸ“„ PDF
                        </a>
                        {% else %}
                        <span class="no-certificate">-</span>
                        {% endif %}
                    </td>
                    <td class="description-cell">{{ record.description[:50] }}{% if record.description|length > 50 %}...{% endif %}</td>
                    <td>
                        <button type="button" class="btn btn-primary btn-sm edit-ce-btn"
                                data-id="{{ record.id }}"
                                data-title="{{ record.title|e }}"
                                data-provider="{{ (record.provider or '')|e }}"
                                data-hours="{{ record.hours }}"
                                data-date="{{ record.date_completed.strftime('%Y-%m-%d') }}"
                                data-category="{{ (record.category or '')|e }}"
                                data-description="{{ (record.description or '')|e }}"
                                data-napfa-approved="{{ 'true' if record.is_napfa_approved else 'false' }}"
                                data-ethics-course="{{ 'true' if record.is_ethics_course else 'false' }}"
                                data-napfa-subject-area="{{ (record.napfa_subject_area or '')|e }}"
                                data-certificate-filename="{{ (record.certificate_filename or '')|e }}"
                                onclick="openEditCEModal(this)">Edit</button>
                        <form method="POST" action="{{ url_for('ce_records.delete_ce', ce_id=record.id) }}"
                              onsubmit="return confirm('Are you sure you want to delete this CE record?');"
                              style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>No CE records yet. <button type="button" class="btn-link" onclick="openAddCEModal()">Add your first CE record</button> to get started!</p>
    </div>
    {% endif %}
</div>

<!-- Add CE Modal -->
<div id="addCEModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add CE Record</h2>
            <button type="button" class="modal-close" onclick="closeAddCEModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('ce_records.add_ce') }}" class="ce-form" enctype="multipart/form-data" id="addCEForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="modal_title">Title *</label>
                    <input type="text" id="modal_title" name="title" required placeholder="e.g., Advanced Tax Planning Seminar">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="modal_provider">Provider</label>
                        <input type="text" id="modal_provider" name="provider" placeholder="e.g., AICPA">
                    </div>

                    <div class="form-group">
                        <label for="modal_category">Category</label>
                        <input type="text" id="modal_category" name="category" placeholder="e.g., Taxation, Ethics">
                    </div>
                </div>

                {% if user.is_napfa_member %}
                <div class="form-group">
                    <label for="modal_napfa_subject_area">NAPFA Subject Area</label>
                    <select id="modal_napfa_subject_area" name="napfa_subject_area">
                        <option value="">Select a subject area...</option>
                        <option value="Financial Planning Process">Financial Planning Process</option>
                        <option value="Insurance & Risk Management">Insurance & Risk Management</option>
                        <option value="Investments">Investments</option>
                        <option value="Income Tax Planning">Income Tax Planning</option>
                        <option value="Retirement Planning & Employee Benefits">Retirement Planning & Employee Benefits</option>
                        <option value="Estate Planning">Estate Planning</option>
                        <option value="Ethics">Ethics</option>
                        <option value="Accounting, Cash Flow Management, & Budgeting">Accounting, Cash Flow Management, & Budgeting</option>
                        <option value="Economic & Political Environment">Economic & Political Environment</option>
                        <option value="Communications">Communications</option>
                        <option value="Marketing and Practice Management">Marketing and Practice Management</option>
                        <option value="Strategic Thinking">Strategic Thinking</option>
                        <option value="Technology">Technology</option>
                        <option value="Diversity, Equity & Inclusion (DEI)">Diversity, Equity & Inclusion (DEI)</option>
                    </select>
                </div>
                {% endif %}

                <div class="form-row">
                    <div class="form-group">
                        <label for="modal_hours">Hours *</label>
                        <input type="number" id="modal_hours" name="hours" required step="0.5" min="0" placeholder="e.g., 2, 2.5, 3">
                    </div>

                    <div class="form-group">
                        <label for="modal_date_completed">Date Completed *</label>
                        <input type="date" id="modal_date_completed" name="date_completed" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="modal_description">Description</label>
                    <textarea id="modal_description" name="description" rows="4" placeholder="Optional description of the CE activity"></textarea>
                </div>

                <div class="form-group">
                    <label>Certificate (PDF)</label>
                    <div class="file-upload-area" id="modal-file-upload-area">
                        <input type="file" id="modal_certificate" name="certificate" accept=".pdf" style="display: none;">
                        <div class="file-upload-content">
                            <svg class="file-upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p class="file-upload-text">Drag and drop your certificate PDF here, or <span class="file-upload-link">click to browse</span></p>
                            <p class="file-upload-hint">Only PDF files are accepted (max 16MB)</p>
                        </div>
                        <div class="file-upload-preview" id="modal-file-preview" style="display: none;">
                            <span class="file-name" id="modal-file-name"></span>
                            <button type="button" class="file-remove" id="modal-file-remove">Ã—</button>
                        </div>
                    </div>
                </div>

                {% if user.is_napfa_member %}
                <div class="form-group">
                    <label class="designation-label">
                        <input type="checkbox" name="is_napfa_approved" id="modal_is_napfa_approved">
                        <span>NAPFA-Approved Source</span>
                    </label>
                    <small>Check if this CE is from NAPFA or a NAPFA-approved source (CFPÂ®, CFA, CPA, CLE, CLU, EA, ChFC, CIMA, CIMC, CPWA, CRPS, RICP, CDFA, AIF, IAR, or state licensure requirements)</small>
                </div>

                <div class="form-group">
                    <label class="designation-label">
                        <input type="checkbox" name="is_ethics_course" id="modal_is_ethics_course">
                        <span>2-CE Ethics Course</span>
                    </label>
                    <small>Check if this is your required 2-CE Ethics course for NAPFA</small>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Add CE Record</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddCEModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit CE Modal -->
<div id="editCEModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit CE Record</h2>
            <button type="button" class="modal-close" onclick="closeEditCEModal()">&times;</button>
        </div>
        <form method="POST" action="" class="ce-form" enctype="multipart/form-data" id="editCEForm">
            <div class="modal-body">
                <input type="hidden" id="edit_ce_id" name="ce_id" value="">

                <div class="form-group">
                    <label for="edit_title">Title *</label>
                    <input type="text" id="edit_title" name="title" required placeholder="e.g., Advanced Tax Planning Seminar">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_provider">Provider</label>
                        <input type="text" id="edit_provider" name="provider" placeholder="e.g., AICPA">
                    </div>

                    <div class="form-group">
                        <label for="edit_category">Category</label>
                        <input type="text" id="edit_category" name="category" placeholder="e.g., Taxation, Ethics">
                    </div>
                </div>

                {% if user.is_napfa_member %}
                <div class="form-group">
                    <label for="edit_napfa_subject_area">NAPFA Subject Area</label>
                    <select id="edit_napfa_subject_area" name="napfa_subject_area">
                        <option value="">Select a subject area...</option>
                        <option value="Financial Planning Process">Financial Planning Process</option>
                        <option value="Insurance & Risk Management">Insurance & Risk Management</option>
                        <option value="Investments">Investments</option>
                        <option value="Income Tax Planning">Income Tax Planning</option>
                        <option value="Retirement Planning & Employee Benefits">Retirement Planning & Employee Benefits</option>
                        <option value="Estate Planning">Estate Planning</option>
                        <option value="Ethics">Ethics</option>
                        <option value="Accounting, Cash Flow Management, & Budgeting">Accounting, Cash Flow Management, & Budgeting</option>
                        <option value="Economic & Political Environment">Economic & Political Environment</option>
                        <option value="Communications">Communications</option>
                        <option value="Marketing and Practice Management">Marketing and Practice Management</option>
                        <option value="Strategic Thinking">Strategic Thinking</option>
                        <option value="Technology">Technology</option>
                        <option value="Diversity, Equity & Inclusion (DEI)">Diversity, Equity & Inclusion (DEI)</option>
                    </select>
                </div>
                {% endif %}

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_hours">Hours *</label>
                        <input type="number" id="edit_hours" name="hours" required step="0.5" min="0" placeholder="e.g., 2, 2.5, 3">
                    </div>

                    <div class="form-group">
                        <label for="edit_date_completed">Date Completed *</label>
                        <input type="date" id="edit_date_completed" name="date_completed" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit_description">Description</label>
                    <textarea id="edit_description" name="description" rows="4" placeholder="Optional description of the CE activity"></textarea>
                </div>

                <div class="form-group">
                    <label>Certificate (PDF)</label>
                    <div id="edit-current-certificate" style="display: none; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">Current file: <strong id="edit-current-cert-name"></strong></span>
                        <small style="color: var(--text-secondary); display: block;">Upload a new file below to replace it, or leave empty to keep the current certificate.</small>
                    </div>
                    <div class="file-upload-area" id="edit-file-upload-area">
                        <input type="file" id="edit_certificate" name="certificate" accept=".pdf" style="display: none;">
                        <div class="file-upload-content">
                            <svg class="file-upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p class="file-upload-text">Drag and drop your certificate PDF here, or <span class="file-upload-link">click to browse</span></p>
                            <p class="file-upload-hint">Only PDF files are accepted (max 16MB)</p>
                        </div>
                        <div class="file-upload-preview" id="edit-file-preview" style="display: none;">
                            <span class="file-name" id="edit-file-name"></span>
                            <button type="button" class="file-remove" id="edit-file-remove">&times;</button>
                        </div>
                    </div>
                </div>

                {% if user.is_napfa_member %}
                <div class="form-group">
                    <label class="designation-label">
                        <input type="checkbox" name="is_napfa_approved" id="edit_is_napfa_approved">
                        <span>NAPFA-Approved Source</span>
                    </label>
                    <small>Check if this CE is from NAPFA or a NAPFA-approved source (CFP, CFA, CPA, CLE, CLU, EA, ChFC, CIMA, CIMC, CPWA, CRPS, RICP, CDFA, AIF, IAR, or state licensure requirements)</small>
                </div>

                <div class="form-group">
                    <label class="designation-label">
                        <input type="checkbox" name="is_ethics_course" id="edit_is_ethics_course">
                        <span>2-CE Ethics Course</span>
                    </label>
                    <small>Check if this is your required 2-CE Ethics course for NAPFA</small>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditCEModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Import CSV Modal -->
<div id="importCSVModal" class="modal">
    <div class="modal-content import-modal">
        <div class="modal-header">
            <h2>Import CE Records from CSV</h2>
            <button type="button" class="modal-close" onclick="closeImportModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('ce_records.import_ce') }}" enctype="multipart/form-data" id="importCSVForm">
            <div class="modal-body">
                <p class="import-intro">Upload a CSV file to bulk import your CE records. This is perfect for migrating historical data.</p>

                <div class="import-format-info">
                    <h4>Expected CSV Format</h4>
                    <p>Your CSV should have a header row with these columns (only Title and Hours are required):</p>
                    <table class="import-format-table">
                        <thead>
                            <tr>
                                <th>Column</th>
                                <th>Required</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Date Completed</td><td>No*</td><td>2025-06-15 or 06/15/2025</td></tr>
                            <tr><td>Title</td><td>Yes</td><td>Advanced Tax Planning</td></tr>
                            <tr><td>Provider</td><td>No</td><td>AICPA</td></tr>
                            <tr><td>Category</td><td>No</td><td>Taxation</td></tr>
                            <tr><td>Hours</td><td>Yes</td><td>2.5</td></tr>
                            <tr><td>Description</td><td>No</td><td>Annual update course</td></tr>
                        </tbody>
                    </table>
                    <small>*If no date is provided, today's date will be used. Duplicate records (same title, date, and hours) will be skipped automatically.</small>
                </div>

                <div class="import-tip">
                    <strong>Tip:</strong> You can export your current records as CSV first to see the exact format, then use the same format for importing.
                </div>

                <div class="form-group">
                    <label for="csv_file">Select CSV File *</label>
                    <div class="file-upload-area" id="import-file-upload-area">
                        <input type="file" id="csv_file" name="csv_file" accept=".csv" required style="display: none;">
                        <div class="file-upload-content">
                            <svg class="file-upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p class="file-upload-text">Drag and drop your CSV file here, or <span class="file-upload-link">click to browse</span></p>
                            <p class="file-upload-hint">Only .csv files are accepted</p>
                        </div>
                        <div class="file-upload-preview" id="import-file-preview" style="display: none;">
                            <span class="file-name" id="import-file-name"></span>
                            <button type="button" class="file-remove" id="import-file-remove">&times;</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Import Records</button>
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Import CSV Modal functions
    function openImportModal() {
        document.getElementById('importCSVModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeImportModal() {
        document.getElementById('importCSVModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('importCSVForm').reset();
        document.getElementById('import-file-preview').style.display = 'none';
        document.querySelector('#import-file-upload-area .file-upload-content').style.display = 'block';
    }

    // Import file upload handling
    (function() {
        var fileInput = document.getElementById('csv_file');
        var uploadArea = document.getElementById('import-file-upload-area');
        var filePreview = document.getElementById('import-file-preview');
        var fileName = document.getElementById('import-file-name');
        var fileRemove = document.getElementById('import-file-remove');
        var uploadContent = uploadArea.querySelector('.file-upload-content');

        uploadArea.addEventListener('click', function(e) {
            if (e.target === uploadArea || e.target.closest('.file-upload-content')) {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('Please select a CSV file.');
                    fileInput.value = '';
                    return;
                }
                fileName.textContent = file.name;
                uploadContent.style.display = 'none';
                filePreview.style.display = 'flex';
            }
        });

        fileRemove.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.value = '';
            filePreview.style.display = 'none';
            uploadContent.style.display = 'block';
        });

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            var file = e.dataTransfer.files[0];
            if (file) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('Please drop a CSV file.');
                    return;
                }
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = file.name;
                uploadContent.style.display = 'none';
                filePreview.style.display = 'flex';
            }
        });
    })();

    // Modal functions
    function openAddCEModal() {
        document.getElementById('addCEModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeAddCEModal() {
        document.getElementById('addCEModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        // Reset form
        document.getElementById('addCEForm').reset();
        // Reset file preview
        document.getElementById('modal-file-preview').style.display = 'none';
        document.querySelector('#modal-file-upload-area .file-upload-content').style.display = 'block';
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        var addModal = document.getElementById('addCEModal');
        var editModal = document.getElementById('editCEModal');
        var importModal = document.getElementById('importCSVModal');
        if (event.target === addModal) {
            closeAddCEModal();
        }
        if (event.target === editModal) {
            closeEditCEModal();
        }
        if (event.target === importModal) {
            closeImportModal();
        }
    }

    // File upload handling for modal
    const modalFileInput = document.getElementById('modal_certificate');
    const modalFileUploadArea = document.getElementById('modal-file-upload-area');
    const modalFilePreview = document.getElementById('modal-file-preview');
    const modalFileName = document.getElementById('modal-file-name');
    const modalFileRemove = document.getElementById('modal-file-remove');
    const modalFileUploadContent = modalFileUploadArea.querySelector('.file-upload-content');
    const modalFileUploadLink = modalFileUploadArea.querySelector('.file-upload-link');

    // Click to browse
    if (modalFileUploadLink) {
        modalFileUploadLink.addEventListener('click', () => modalFileInput.click());
    }
    modalFileUploadArea.addEventListener('click', (e) => {
        if (e.target === modalFileUploadArea || e.target.closest('.file-upload-content')) {
            modalFileInput.click();
        }
    });

    // File input change
    modalFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file.');
                modalFileInput.value = '';
                return;
            }
            if (file.size > 16 * 1024 * 1024) {
                alert('File size must be less than 16MB.');
                modalFileInput.value = '';
                return;
            }
            modalFileName.textContent = file.name;
            modalFileUploadContent.style.display = 'none';
            modalFilePreview.style.display = 'flex';
        }
    });

    // Remove file
    modalFileRemove.addEventListener('click', (e) => {
        e.stopPropagation();
        modalFileInput.value = '';
        modalFilePreview.style.display = 'none';
        modalFileUploadContent.style.display = 'block';
    });

    // Drag and drop
    modalFileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        modalFileUploadArea.classList.add('drag-over');
    });

    modalFileUploadArea.addEventListener('dragleave', () => {
        modalFileUploadArea.classList.remove('drag-over');
    });

    modalFileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        modalFileUploadArea.classList.remove('drag-over');

        const file = e.dataTransfer.files[0];
        if (file) {
            if (file.type !== 'application/pdf') {
                alert('Please drop a PDF file.');
                return;
            }
            if (file.size > 16 * 1024 * 1024) {
                alert('File size must be less than 16MB.');
                return;
            }
            modalFileInput.files = e.dataTransfer.files;
            modalFileName.textContent = file.name;
            modalFileUploadContent.style.display = 'none';
            modalFilePreview.style.display = 'flex';
        }
    });

    // ==========================================
    // Edit CE Modal Functions
    // ==========================================

    function openEditCEModal(button) {
        // Read data attributes from the clicked button
        var id = button.getAttribute('data-id');
        var title = button.getAttribute('data-title');
        var provider = button.getAttribute('data-provider');
        var hours = button.getAttribute('data-hours');
        var dateCompleted = button.getAttribute('data-date');
        var category = button.getAttribute('data-category');
        var description = button.getAttribute('data-description');
        var isNapfaApproved = button.getAttribute('data-napfa-approved') === 'true';
        var isEthicsCourse = button.getAttribute('data-ethics-course') === 'true';
        var napfaSubjectArea = button.getAttribute('data-napfa-subject-area');
        var certificateFilename = button.getAttribute('data-certificate-filename');

        // Set form action
        document.getElementById('editCEForm').action = '{{ url_for("ce_records.edit_ce", ce_id=0) }}'.replace('0', id);

        // Populate hidden ID
        document.getElementById('edit_ce_id').value = id;

        // Populate form fields
        document.getElementById('edit_title').value = title;
        document.getElementById('edit_provider').value = provider;
        document.getElementById('edit_category').value = category;
        document.getElementById('edit_hours').value = hours;
        document.getElementById('edit_date_completed').value = dateCompleted;
        document.getElementById('edit_description').value = description;

        // NAPFA fields (only exist if user is NAPFA member)
        var napfaSubjectAreaSelect = document.getElementById('edit_napfa_subject_area');
        if (napfaSubjectAreaSelect) {
            napfaSubjectAreaSelect.value = napfaSubjectArea || '';
        }
        var napfaApprovedCheckbox = document.getElementById('edit_is_napfa_approved');
        if (napfaApprovedCheckbox) {
            napfaApprovedCheckbox.checked = isNapfaApproved;
        }
        var ethicsCourseCheckbox = document.getElementById('edit_is_ethics_course');
        if (ethicsCourseCheckbox) {
            ethicsCourseCheckbox.checked = isEthicsCourse;
        }

        // Handle certificate display
        var currentCertDiv = document.getElementById('edit-current-certificate');
        var currentCertName = document.getElementById('edit-current-cert-name');
        if (certificateFilename) {
            currentCertName.textContent = certificateFilename;
            currentCertDiv.style.display = 'block';
        } else {
            currentCertDiv.style.display = 'none';
        }

        // Reset file upload state
        document.getElementById('edit_certificate').value = '';
        document.getElementById('edit-file-preview').style.display = 'none';
        document.querySelector('#edit-file-upload-area .file-upload-content').style.display = 'block';

        // Show the modal
        document.getElementById('editCEModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeEditCEModal() {
        document.getElementById('editCEModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        // Reset form
        document.getElementById('editCEForm').reset();
        // Reset file preview
        document.getElementById('edit-file-preview').style.display = 'none';
        document.querySelector('#edit-file-upload-area .file-upload-content').style.display = 'block';
        // Hide current certificate info
        document.getElementById('edit-current-certificate').style.display = 'none';
    }

    // File upload handling for Edit modal
    var editFileInput = document.getElementById('edit_certificate');
    var editFileUploadArea = document.getElementById('edit-file-upload-area');
    var editFilePreview = document.getElementById('edit-file-preview');
    var editFileName = document.getElementById('edit-file-name');
    var editFileRemove = document.getElementById('edit-file-remove');
    var editFileUploadContent = editFileUploadArea.querySelector('.file-upload-content');
    var editFileUploadLink = editFileUploadArea.querySelector('.file-upload-link');

    // Click to browse
    if (editFileUploadLink) {
        editFileUploadLink.addEventListener('click', function() { editFileInput.click(); });
    }
    editFileUploadArea.addEventListener('click', function(e) {
        if (e.target === editFileUploadArea || e.target.closest('.file-upload-content')) {
            editFileInput.click();
        }
    });

    // File input change
    editFileInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (file) {
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file.');
                editFileInput.value = '';
                return;
            }
            if (file.size > 16 * 1024 * 1024) {
                alert('File size must be less than 16MB.');
                editFileInput.value = '';
                return;
            }
            editFileName.textContent = file.name;
            editFileUploadContent.style.display = 'none';
            editFilePreview.style.display = 'flex';
        }
    });

    // Remove file
    editFileRemove.addEventListener('click', function(e) {
        e.stopPropagation();
        editFileInput.value = '';
        editFilePreview.style.display = 'none';
        editFileUploadContent.style.display = 'block';
    });

    // Drag and drop for edit modal
    editFileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        editFileUploadArea.classList.add('drag-over');
    });

    editFileUploadArea.addEventListener('dragleave', function() {
        editFileUploadArea.classList.remove('drag-over');
    });

    editFileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        editFileUploadArea.classList.remove('drag-over');

        var file = e.dataTransfer.files[0];
        if (file) {
            if (file.type !== 'application/pdf') {
                alert('Please drop a PDF file.');
                return;
            }
            if (file.size > 16 * 1024 * 1024) {
                alert('File size must be less than 16MB.');
                return;
            }
            editFileInput.files = e.dataTransfer.files;
            editFileName.textContent = file.name;
            editFileUploadContent.style.display = 'none';
            editFilePreview.style.display = 'flex';
        }
    });
</script>
{% endblock %}

