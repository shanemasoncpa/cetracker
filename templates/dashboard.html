{% extends "base.html" %}

{% block title %}Dashboard - CE Tracker{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Your CE Records</h1>
        <div class="header-actions">
            <button type="button" class="btn btn-primary" onclick="openAddCEModal()">+ Add New CE</button>
            <div class="dropdown">
                <button type="button" class="btn btn-secondary dropdown-toggle" onclick="toggleDropdown(this)">Data Tools &#9662;</button>
                <div class="dropdown-menu">
                    <button type="button" class="dropdown-item" onclick="openImportModal()">ðŸ“¤ Import CSV</button>
                    <a href="{{ url_for('ce_records.export_ce', category=filter_category) }}" class="dropdown-item">ðŸ“¥ Export CSV</a>
                    <a href="{{ url_for('ce_records.export_pdf', category=filter_category) }}" class="dropdown-item">ðŸ“„ Export PDF</a>
                    <a href="{{ url_for('ce_records.export_backup') }}" class="dropdown-item">ðŸ’¾ Backup Data</a>
                    <button type="button" class="dropdown-item" onclick="openRestoreModal()">ðŸ“‚ Restore Backup</button>
                </div>
            </div>
        </div>
    </div>

    {% if user_designations %}
    <div class="designations-section">
        <h2>Your Designations</h2>
        <div class="designation-badges">
            {% for user_designation in user_designations %}
            <span class="designation-badge-small">
                {{ user_designation.designation }}
                {% if user_designation.designation == 'CPA' and user_designation.state %}
                ({{ user_designation.state }})
                {% endif %}
            </span>
            {% endfor %}
            <a href="{{ url_for('designations.manage_designations') }}" class="btn btn-secondary btn-sm">Manage</a>
        </div>
    </div>
    
    {% if designation_requirements %}
    <div class="designation-requirements-section">
        <h2>CE Requirements Progress</h2>
        <div class="requirements-grid">
            {% for req in designation_requirements %}
            <div class="requirement-card {% if req.is_complete %}complete{% endif %}">
                <div class="requirement-header">
                    <h3>
                        {{ req.designation }}
                        {% if req.state %}({{ req.state }}){% endif %}
                    </h3>
                    {% if req.is_complete %}
                    <span class="status-badge complete">âœ“ Complete</span>
                    {% else %}
                    <span class="status-badge incomplete">In Progress</span>
                    {% endif %}
                </div>
                
                <div class="requirement-period">
                    <small>Reporting Period: {{ req.period_start.strftime('%b %d, %Y') }} - {{ req.period_end.strftime('%b %d, %Y') }}</small>
                </div>
                
                <div class="requirement-progress-main">
                    <div class="progress-header">
                        <span class="progress-label">Total Hours</span>
                        <span class="progress-numbers">{{ "%.1f"|format(req.total_earned) }} / {{ "%.1f"|format(req.total_required) }}</span>
                    </div>
                    <div class="progress-bar-large">
                        <div class="progress-fill-large" style="width: {{ req.total_percentage }}%"></div>
                    </div>
                    {% if req.total_remaining > 0 %}
                    <p class="remaining-text">{{ "%.1f"|format(req.total_remaining) }} hours remaining</p>
                    {% else %}
                    <p class="complete-text">âœ“ Requirement met!</p>
                    {% endif %}
                </div>
                
                {% if req.ethics_required %}
                <div class="requirement-progress-sub">
                    <div class="progress-header">
                        <span class="progress-label">Ethics Hours</span>
                        <span class="progress-numbers">{{ "%.1f"|format(req.ethics_earned) }} / {{ "%.1f"|format(req.ethics_required) }}</span>
                    </div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" style="width: {{ req.ethics_percentage }}%"></div>
                    </div>
                    {% if req.ethics_remaining > 0 %}
                    <p class="remaining-text-small">{{ "%.1f"|format(req.ethics_remaining) }} hours remaining</p>
                    {% else %}
                    <p class="complete-text-small">âœ“ Ethics requirement met!</p>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if req.yearly_minimum %}
                <div class="requirement-progress-sub">
                    <div class="progress-header">
                        <span class="progress-label">Current Year Minimum</span>
                        <span class="progress-numbers">{{ "%.1f"|format(req.current_year_hours) }} / {{ "%.1f"|format(req.yearly_minimum) }}</span>
                    </div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" style="width: {{ req.yearly_percentage }}%"></div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="designations-section">
        <p>No designations yet. <a href="{{ url_for('designations.manage_designations') }}">Add your designations</a> to track CE requirements!</p>
    </div>
    {% endif %}

    {% if napfa_requirements %}
    <div class="napfa-section">
        <div class="napfa-header">
            <h2>NAPFA CE Requirements</h2>
            <form method="POST" action="{{ url_for('ce_records.toggle_napfa_tracking') }}" style="display: inline;">
                <button type="submit" class="btn btn-secondary btn-sm">
                    {{ 'Hide' if show_napfa else 'Show' }} NAPFA Tracking
                </button>
            </form>
        </div>
        {% if show_napfa %}
        <div class="napfa-status">
            <div class="napfa-cycle-info">
                <p><strong>Current Cycle:</strong> {{ napfa_requirements.cycle_start.strftime('%B %d, %Y') }} - {{ napfa_requirements.cycle_end.strftime('%B %d, %Y') }}</p>
            </div>
            
            <div class="napfa-requirements-grid">
                <div class="napfa-requirement-item {% if napfa_requirements.is_complete %}complete{% endif %}">
                    <div class="requirement-header">
                        <span class="requirement-label">Total CE Hours</span>
                        {% if napfa_requirements.is_complete %}
                        <span class="requirement-status complete">âœ“ Complete</span>
                        {% else %}
                        <span class="requirement-status incomplete">Incomplete</span>
                        {% endif %}
                    </div>
                    <div class="requirement-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ napfa_requirements.total_percentage }}%"></div>
                        </div>
                        <span class="progress-text">{{ "%.1f"|format(napfa_requirements.total_earned) }} / {{ napfa_requirements.total_required }} hours</span>
                    </div>
                    {% if napfa_requirements.total_remaining > 0 %}
                    <p class="requirement-remaining">{{ "%.1f"|format(napfa_requirements.total_remaining) }} hours remaining</p>
                    {% endif %}
                </div>

                <div class="napfa-requirement-item {% if napfa_requirements.napfa_approved_earned >= napfa_requirements.napfa_approved_required %}complete{% endif %}">
                    <div class="requirement-header">
                        <span class="requirement-label">NAPFA-Approved Sources</span>
                        {% if napfa_requirements.napfa_approved_earned >= napfa_requirements.napfa_approved_required %}
                        <span class="requirement-status complete">âœ“ Complete</span>
                        {% else %}
                        <span class="requirement-status incomplete">Incomplete</span>
                        {% endif %}
                    </div>
                    <div class="requirement-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ napfa_requirements.napfa_approved_percentage }}%"></div>
                        </div>
                        <span class="progress-text">{{ "%.1f"|format(napfa_requirements.napfa_approved_earned) }} / {{ napfa_requirements.napfa_approved_required }} hours</span>
                    </div>
                    {% if napfa_requirements.napfa_approved_remaining > 0 %}
                    <p class="requirement-remaining">{{ "%.1f"|format(napfa_requirements.napfa_approved_remaining) }} hours remaining</p>
                    {% endif %}
                </div>

                <div class="napfa-requirement-item {% if napfa_requirements.ethics_completed %}complete{% endif %}">
                    <div class="requirement-header">
                        <span class="requirement-label">2-CE Ethics Course</span>
                        {% if napfa_requirements.ethics_completed %}
                        <span class="requirement-status complete">âœ“ Complete</span>
                        {% else %}
                        <span class="requirement-status incomplete">Required</span>
                        {% endif %}
                    </div>
                    {% if not napfa_requirements.ethics_completed %}
                    <p class="requirement-remaining">You must complete a 2-CE Ethics course</p>
                    {% endif %}
                </div>
            </div>

            {% if napfa_requirements.is_complete %}
            <div class="napfa-complete-message">
                <p>âœ“ Congratulations! You have met all NAPFA CE requirements for the current cycle.</p>
            </div>
            {% else %}
            <div class="napfa-info">
                <p><small>Based on <a href="https://www.napfa.org/member-resources/ce-guidelines" target="_blank">NAPFA CE Guidelines</a>. Mark CEs as "NAPFA-Approved" when adding them to count toward the approved sources requirement.</small></p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="stats-card">
        <div class="stat-item">
            <span class="stat-label">Total CE Hours{% if filter_category %} ({{ filter_category }}){% endif %}</span>
            <span class="stat-value">{{ "%.1f"|format(total_hours) }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Total Records{% if filter_category %} ({{ filter_category }}){% endif %}</span>
            <span class="stat-value">{{ ce_records|length }}</span>
        </div>
    </div>

    {% if ce_records %}
    <div class="table-container">
        <div class="filter-section">
            <form method="GET" action="{{ url_for('ce_records.dashboard') }}" class="filter-form">
                <div class="filter-group">
                    <label for="category">Filter by Category:</label>
                    <select id="category" name="category" onchange="this.form.submit()">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if filter_category == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% if filter_category %}
                <a href="{{ url_for('ce_records.dashboard') }}" class="btn btn-secondary btn-sm">Clear Filter</a>
                {% endif %}
            </form>
        </div>
        <table class="ce-table" id="ceTable">
            <thead>
                <tr>
                    <th class="sortable sort-active" data-sort="date" data-dir="desc">Date Completed <span class="sort-indicator">&#9660;</span></th>
                    <th class="sortable" data-sort="text" data-col="1">Title <span class="sort-indicator">&#9650;</span></th>
                    <th class="sortable" data-sort="text" data-col="2">Provider <span class="sort-indicator">&#9650;</span></th>
                    <th class="sortable" data-sort="text" data-col="3">Category <span class="sort-indicator">&#9650;</span></th>
                    <th class="sortable" data-sort="number" data-col="4">Hours <span class="sort-indicator">&#9650;</span></th>
                    {% if napfa_requirements %}
                    <th>NAPFA</th>
                    {% endif %}
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for record in ce_records %}
                <tr>
                    <td>{{ record.date_completed.strftime('%Y-%m-%d') }}</td>
                    <td><strong>{{ record.title }}</strong></td>
                    <td>{{ record.provider or '-' }}</td>
                    <td>{{ record.category or '-' }}</td>
                    <td class="hours-cell">{{ "%.1f"|format(record.hours) }}</td>
                    {% if napfa_requirements %}
                    <td>
                        {% if record.is_napfa_approved %}
                        <span class="napfa-badge approved" title="NAPFA-Approved Source">âœ“ Approved</span>
                        {% endif %}
                        {% if record.is_ethics_course %}
                        <span class="napfa-badge ethics" title="2-CE Ethics Course">âš– Ethics</span>
                        {% endif %}
                        {% if not record.is_napfa_approved and not record.is_ethics_course %}
                        <span class="napfa-badge none">-</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td class="description-cell">{{ record.description[:50] }}{% if record.description|length > 50 %}...{% endif %}</td>
                    <td class="actions-cell">
                        <button type="button" class="btn btn-primary btn-sm edit-ce-btn"
                                data-id="{{ record.id }}"
                                data-title="{{ record.title|e }}"
                                data-provider="{{ (record.provider or '')|e }}"
                                data-hours="{{ record.hours }}"
                                data-date="{{ record.date_completed.strftime('%Y-%m-%d') }}"
                                data-category="{{ (record.category or '')|e }}"
                                data-description="{{ (record.description or '')|e }}"
                                data-napfa-approved="{{ 'true' if record.is_napfa_approved else 'false' }}"
                                data-ethics-course="{{ 'true' if record.is_ethics_course else 'false' }}"
                                data-napfa-subject-area="{{ (record.napfa_subject_area or '')|e }}"
                                onclick="openEditCEModal(this)">Edit</button>
                        <form method="POST" action="{{ url_for('ce_records.delete_ce', ce_id=record.id) }}"
                              onsubmit="return confirm('Are you sure you want to delete this CE record?');"
                              style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>No CE records yet. <button type="button" class="btn-link" onclick="openAddCEModal()">Add your first CE record</button> to get started!</p>
    </div>
    {% endif %}
</div>

<!-- Add CE Modal -->
<div id="addCEModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add CE Record</h2>
            <button type="button" class="modal-close" onclick="closeAddCEModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('ce_records.add_ce') }}" class="ce-form" id="addCEForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="modal_title">Title *</label>
                    <input type="text" id="modal_title" name="title" required placeholder="e.g., Advanced Tax Planning Seminar">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="modal_provider">Provider</label>
                        <input type="text" id="modal_provider" name="provider" placeholder="e.g., AICPA">
                    </div>

                    <div class="form-group">
                        <label for="modal_category">Category</label>
                        <input type="text" id="modal_category" name="category" placeholder="e.g., Taxation, Ethics">
                    </div>
                </div>

                {% if user.is_napfa_member %}
                <div class="form-group">
                    <label for="modal_napfa_subject_area">NAPFA Subject Area</label>
                    <select id="modal_napfa_subject_area" name="napfa_subject_area">
                        <option value="">Select a subject area...</option>
                        <option value="Financial Planning Process">Financial Planning Process</option>
                        <option value="Insurance & Risk Management">Insurance & Risk Management</option>
                        <option value="Investments">Investments</option>
                        <option value="Income Tax Planning">Income Tax Planning</option>
                        <option value="Retirement Planning & Employee Benefits">Retirement Planning & Employee Benefits</option>
                        <option value="Estate Planning">Estate Planning</option>
                        <option value="Ethics">Ethics</option>
                        <option value="Accounting, Cash Flow Management, & Budgeting">Accounting, Cash Flow Management, & Budgeting</option>
                        <option value="Economic & Political Environment">Economic & Political Environment</option>
                        <option value="Communications">Communications</option>
                        <option value="Marketing and Practice Management">Marketing and Practice Management</option>
                        <option value="Strategic Thinking">Strategic Thinking</option>
                        <option value="Technology">Technology</option>
                        <option value="Diversity, Equity & Inclusion (DEI)">Diversity, Equity & Inclusion (DEI)</option>
                    </select>
                </div>
                {% endif %}

                <div class="form-row">
                    <div class="form-group">
                        <label for="modal_hours">Hours *</label>
                        <input type="number" id="modal_hours" name="hours" required step="0.5" min="0" placeholder="e.g., 2, 2.5, 3">
                    </div>

                    <div class="form-group">
                        <label for="modal_date_completed">Date Completed *</label>
                        <input type="date" id="modal_date_completed" name="date_completed" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="modal_description">Description</label>
                    <textarea id="modal_description" name="description" rows="4" placeholder="Optional description of the CE activity"></textarea>
                </div>

                {% if user.is_napfa_member %}
                <div class="form-group">
                    <label class="designation-label">
                        <input type="checkbox" name="is_napfa_approved" id="modal_is_napfa_approved">
                        <span>NAPFA-Approved Source</span>
                    </label>
                    <small>Check if this CE is from NAPFA or a NAPFA-approved source (CFPÂ®, CFA, CPA, CLE, CLU, EA, ChFC, CIMA, CIMC, CPWA, CRPS, RICP, CDFA, AIF, IAR, or state licensure requirements)</small>
                </div>

                <div class="form-group">
                    <label class="designation-label">
                        <input type="checkbox" name="is_ethics_course" id="modal_is_ethics_course">
                        <span>2-CE Ethics Course</span>
                    </label>
                    <small>Check if this is your required 2-CE Ethics course for NAPFA</small>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Add CE Record</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddCEModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit CE Modal -->
<div id="editCEModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit CE Record</h2>
            <button type="button" class="modal-close" onclick="closeEditCEModal()">&times;</button>
        </div>
        <form method="POST" action="" class="ce-form" id="editCEForm">
            <div class="modal-body">
                <input type="hidden" id="edit_ce_id" name="ce_id" value="">

                <div class="form-group">
                    <label for="edit_title">Title *</label>
                    <input type="text" id="edit_title" name="title" required placeholder="e.g., Advanced Tax Planning Seminar">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_provider">Provider</label>
                        <input type="text" id="edit_provider" name="provider" placeholder="e.g., AICPA">
                    </div>

                    <div class="form-group">
                        <label for="edit_category">Category</label>
                        <input type="text" id="edit_category" name="category" placeholder="e.g., Taxation, Ethics">
                    </div>
                </div>

                {% if user.is_napfa_member %}
                <div class="form-group">
                    <label for="edit_napfa_subject_area">NAPFA Subject Area</label>
                    <select id="edit_napfa_subject_area" name="napfa_subject_area">
                        <option value="">Select a subject area...</option>
                        <option value="Financial Planning Process">Financial Planning Process</option>
                        <option value="Insurance & Risk Management">Insurance & Risk Management</option>
                        <option value="Investments">Investments</option>
                        <option value="Income Tax Planning">Income Tax Planning</option>
                        <option value="Retirement Planning & Employee Benefits">Retirement Planning & Employee Benefits</option>
                        <option value="Estate Planning">Estate Planning</option>
                        <option value="Ethics">Ethics</option>
                        <option value="Accounting, Cash Flow Management, & Budgeting">Accounting, Cash Flow Management, & Budgeting</option>
                        <option value="Economic & Political Environment">Economic & Political Environment</option>
                        <option value="Communications">Communications</option>
                        <option value="Marketing and Practice Management">Marketing and Practice Management</option>
                        <option value="Strategic Thinking">Strategic Thinking</option>
                        <option value="Technology">Technology</option>
                        <option value="Diversity, Equity & Inclusion (DEI)">Diversity, Equity & Inclusion (DEI)</option>
                    </select>
                </div>
                {% endif %}

                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_hours">Hours *</label>
                        <input type="number" id="edit_hours" name="hours" required step="0.5" min="0" placeholder="e.g., 2, 2.5, 3">
                    </div>

                    <div class="form-group">
                        <label for="edit_date_completed">Date Completed *</label>
                        <input type="date" id="edit_date_completed" name="date_completed" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit_description">Description</label>
                    <textarea id="edit_description" name="description" rows="4" placeholder="Optional description of the CE activity"></textarea>
                </div>

                {% if user.is_napfa_member %}
                <div class="form-group">
                    <label class="designation-label">
                        <input type="checkbox" name="is_napfa_approved" id="edit_is_napfa_approved">
                        <span>NAPFA-Approved Source</span>
                    </label>
                    <small>Check if this CE is from NAPFA or a NAPFA-approved source (CFP, CFA, CPA, CLE, CLU, EA, ChFC, CIMA, CIMC, CPWA, CRPS, RICP, CDFA, AIF, IAR, or state licensure requirements)</small>
                </div>

                <div class="form-group">
                    <label class="designation-label">
                        <input type="checkbox" name="is_ethics_course" id="edit_is_ethics_course">
                        <span>2-CE Ethics Course</span>
                    </label>
                    <small>Check if this is your required 2-CE Ethics course for NAPFA</small>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditCEModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Import CSV Modal -->
<div id="importCSVModal" class="modal">
    <div class="modal-content import-modal">
        <div class="modal-header">
            <h2>Import CE Records from CSV</h2>
            <button type="button" class="modal-close" onclick="closeImportModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('ce_records.import_ce') }}" enctype="multipart/form-data" id="importCSVForm">
            <div class="modal-body">
                <p class="import-intro">Upload a CSV file to bulk import your CE records. This is perfect for migrating historical data.</p>

                <div class="import-format-info">
                    <h4>Expected CSV Format</h4>
                    <p>Your CSV should have a header row with these columns (only Title and Hours are required):</p>
                    <table class="import-format-table">
                        <thead>
                            <tr>
                                <th>Column</th>
                                <th>Required</th>
                                <th>Example</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Date Completed</td><td>No*</td><td>2025-06-15 or 06/15/2025</td></tr>
                            <tr><td>Title</td><td>Yes</td><td>Advanced Tax Planning</td></tr>
                            <tr><td>Provider</td><td>No</td><td>AICPA</td></tr>
                            <tr><td>Category</td><td>No</td><td>Taxation</td></tr>
                            <tr><td>Hours</td><td>Yes</td><td>2.5</td></tr>
                            <tr><td>Description</td><td>No</td><td>Annual update course</td></tr>
                        </tbody>
                    </table>
                    <small>*If no date is provided, today's date will be used. Duplicate records (same title, date, and hours) will be skipped automatically.</small>
                </div>

                <div class="import-tip">
                    <strong>Tip:</strong> You can export your current records as CSV first to see the exact format, then use the same format for importing.
                </div>

                <div class="form-group">
                    <label for="csv_file">Select CSV File *</label>
                    <div class="file-upload-area" id="import-file-upload-area">
                        <input type="file" id="csv_file" name="csv_file" accept=".csv" required style="display: none;">
                        <div class="file-upload-content">
                            <svg class="file-upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p class="file-upload-text">Drag and drop your CSV file here, or <span class="file-upload-link">click to browse</span></p>
                            <p class="file-upload-hint">Only .csv files are accepted</p>
                        </div>
                        <div class="file-upload-preview" id="import-file-preview" style="display: none;">
                            <span class="file-name" id="import-file-name"></span>
                            <button type="button" class="file-remove" id="import-file-remove">&times;</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Import Records</button>
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Restore Backup Modal -->
<div id="restoreBackupModal" class="modal">
    <div class="modal-content import-modal">
        <div class="modal-header">
            <h2>Restore from Backup</h2>
            <button type="button" class="modal-close" onclick="closeRestoreModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('ce_records.import_backup') }}" enctype="multipart/form-data" id="restoreBackupForm">
            <div class="modal-body">
                <p class="import-intro">Upload a JSON backup file previously exported from CE Tracker. Only CE records will be imported â€” duplicates are skipped automatically.</p>

                <div class="form-group">
                    <label for="backup_file">Select Backup File *</label>
                    <div class="file-upload-area" id="restore-file-upload-area">
                        <input type="file" id="backup_file" name="backup_file" accept=".json" required style="display: none;">
                        <div class="file-upload-content">
                            <svg class="file-upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p class="file-upload-text">Drag and drop your backup JSON file here, or <span class="file-upload-link">click to browse</span></p>
                            <p class="file-upload-hint">Only .json files are accepted</p>
                        </div>
                        <div class="file-upload-preview" id="restore-file-preview" style="display: none;">
                            <span class="file-name" id="restore-file-name"></span>
                            <button type="button" class="file-remove" id="restore-file-remove">&times;</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Restore Records</button>
                <button type="button" class="btn btn-secondary" onclick="closeRestoreModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Dropdown toggle
    function toggleDropdown(btn) {
        var menu = btn.nextElementSibling;
        var isOpen = menu.classList.contains('show');
        // Close any open dropdowns first
        document.querySelectorAll('.dropdown-menu.show').forEach(function(m) {
            m.classList.remove('show');
        });
        if (!isOpen) {
            menu.classList.add('show');
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-menu.show').forEach(function(m) {
                m.classList.remove('show');
            });
        }
    });

    // Import CSV Modal functions
    function openImportModal() {
        document.getElementById('importCSVModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeImportModal() {
        document.getElementById('importCSVModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('importCSVForm').reset();
        document.getElementById('import-file-preview').style.display = 'none';
        document.querySelector('#import-file-upload-area .file-upload-content').style.display = 'block';
    }

    // Import file upload handling
    (function() {
        var fileInput = document.getElementById('csv_file');
        var uploadArea = document.getElementById('import-file-upload-area');
        var filePreview = document.getElementById('import-file-preview');
        var fileName = document.getElementById('import-file-name');
        var fileRemove = document.getElementById('import-file-remove');
        var uploadContent = uploadArea.querySelector('.file-upload-content');

        uploadArea.addEventListener('click', function(e) {
            if (e.target === uploadArea || e.target.closest('.file-upload-content')) {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('Please select a CSV file.');
                    fileInput.value = '';
                    return;
                }
                fileName.textContent = file.name;
                uploadContent.style.display = 'none';
                filePreview.style.display = 'flex';
            }
        });

        fileRemove.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.value = '';
            filePreview.style.display = 'none';
            uploadContent.style.display = 'block';
        });

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            var file = e.dataTransfer.files[0];
            if (file) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('Please drop a CSV file.');
                    return;
                }
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = file.name;
                uploadContent.style.display = 'none';
                filePreview.style.display = 'flex';
            }
        });
    })();

    // Restore Backup Modal functions
    function openRestoreModal() {
        document.getElementById('restoreBackupModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeRestoreModal() {
        document.getElementById('restoreBackupModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('restoreBackupForm').reset();
        document.getElementById('restore-file-preview').style.display = 'none';
        document.querySelector('#restore-file-upload-area .file-upload-content').style.display = 'block';
    }

    // Restore file upload handling
    (function() {
        var fileInput = document.getElementById('backup_file');
        var uploadArea = document.getElementById('restore-file-upload-area');
        var filePreview = document.getElementById('restore-file-preview');
        var fileName = document.getElementById('restore-file-name');
        var fileRemove = document.getElementById('restore-file-remove');
        var uploadContent = uploadArea.querySelector('.file-upload-content');

        uploadArea.addEventListener('click', function(e) {
            if (e.target === uploadArea || e.target.closest('.file-upload-content')) {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                if (!file.name.toLowerCase().endsWith('.json')) {
                    alert('Please select a JSON file.');
                    fileInput.value = '';
                    return;
                }
                fileName.textContent = file.name;
                uploadContent.style.display = 'none';
                filePreview.style.display = 'flex';
            }
        });

        fileRemove.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.value = '';
            filePreview.style.display = 'none';
            uploadContent.style.display = 'block';
        });

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            var file = e.dataTransfer.files[0];
            if (file) {
                if (!file.name.toLowerCase().endsWith('.json')) {
                    alert('Please drop a JSON file.');
                    return;
                }
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = file.name;
                uploadContent.style.display = 'none';
                filePreview.style.display = 'flex';
            }
        });
    })();

    // Modal functions
    function openAddCEModal() {
        document.getElementById('addCEModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeAddCEModal() {
        document.getElementById('addCEModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('addCEForm').reset();
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        var addModal = document.getElementById('addCEModal');
        var editModal = document.getElementById('editCEModal');
        var importModal = document.getElementById('importCSVModal');
        var restoreModal = document.getElementById('restoreBackupModal');
        if (event.target === addModal) {
            closeAddCEModal();
        }
        if (event.target === editModal) {
            closeEditCEModal();
        }
        if (event.target === importModal) {
            closeImportModal();
        }
        if (event.target === restoreModal) {
            closeRestoreModal();
        }
    }

    // ==========================================
    // Edit CE Modal Functions
    // ==========================================

    function openEditCEModal(button) {
        // Read data attributes from the clicked button
        var id = button.getAttribute('data-id');
        var title = button.getAttribute('data-title');
        var provider = button.getAttribute('data-provider');
        var hours = button.getAttribute('data-hours');
        var dateCompleted = button.getAttribute('data-date');
        var category = button.getAttribute('data-category');
        var description = button.getAttribute('data-description');
        var isNapfaApproved = button.getAttribute('data-napfa-approved') === 'true';
        var isEthicsCourse = button.getAttribute('data-ethics-course') === 'true';
        var napfaSubjectArea = button.getAttribute('data-napfa-subject-area');

        // Set form action
        document.getElementById('editCEForm').action = '{{ url_for("ce_records.edit_ce", ce_id=0) }}'.replace('0', id);

        // Populate hidden ID
        document.getElementById('edit_ce_id').value = id;

        // Populate form fields
        document.getElementById('edit_title').value = title;
        document.getElementById('edit_provider').value = provider;
        document.getElementById('edit_category').value = category;
        document.getElementById('edit_hours').value = hours;
        document.getElementById('edit_date_completed').value = dateCompleted;
        document.getElementById('edit_description').value = description;

        // NAPFA fields (only exist if user is NAPFA member)
        var napfaSubjectAreaSelect = document.getElementById('edit_napfa_subject_area');
        if (napfaSubjectAreaSelect) {
            napfaSubjectAreaSelect.value = napfaSubjectArea || '';
        }
        var napfaApprovedCheckbox = document.getElementById('edit_is_napfa_approved');
        if (napfaApprovedCheckbox) {
            napfaApprovedCheckbox.checked = isNapfaApproved;
        }
        var ethicsCourseCheckbox = document.getElementById('edit_is_ethics_course');
        if (ethicsCourseCheckbox) {
            ethicsCourseCheckbox.checked = isEthicsCourse;
        }

        // Show the modal
        document.getElementById('editCEModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeEditCEModal() {
        document.getElementById('editCEModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('editCEForm').reset();
    }

    // ==========================================
    // Table Sorting
    // ==========================================
    (function() {
        var table = document.getElementById('ceTable');
        if (!table) return;

        var headers = table.querySelectorAll('th.sortable');
        headers.forEach(function(th) {
            th.addEventListener('click', function() {
                var sortType = th.getAttribute('data-sort');
                var currentDir = th.getAttribute('data-dir');
                var newDir = currentDir === 'asc' ? 'desc' : 'asc';

                // Reset all headers
                headers.forEach(function(h) {
                    h.classList.remove('sort-active');
                    h.setAttribute('data-dir', '');
                    h.querySelector('.sort-indicator').innerHTML = '&#9650;';
                });

                // Set active
                th.classList.add('sort-active');
                th.setAttribute('data-dir', newDir);
                th.querySelector('.sort-indicator').innerHTML = newDir === 'asc' ? '&#9650;' : '&#9660;';

                var colIndex = Array.prototype.indexOf.call(th.parentNode.children, th);
                var tbody = table.querySelector('tbody');
                var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));

                rows.sort(function(a, b) {
                    var aText = a.children[colIndex].textContent.trim();
                    var bText = b.children[colIndex].textContent.trim();
                    var cmp = 0;

                    if (sortType === 'date') {
                        cmp = aText.localeCompare(bText);
                    } else if (sortType === 'number') {
                        cmp = (parseFloat(aText) || 0) - (parseFloat(bText) || 0);
                    } else {
                        cmp = aText.localeCompare(bText, undefined, { sensitivity: 'base' });
                    }

                    return newDir === 'asc' ? cmp : -cmp;
                });

                rows.forEach(function(row) {
                    tbody.appendChild(row);
                });
            });
        });
    })();
</script>
{% endblock %}

